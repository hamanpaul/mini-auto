## 程式碼功能分析報告

### 總結

`arduino_uno.ino` 和 `esp32_cam.ino` 都經歷了顯著的重構，以解決記憶體限制和框架相容性問題。根據原始碼分析，兩者的核心功能都已保留，並且修改主要集中在實現方式上，而非功能本身。

### 1. `arduino_uno.ino` (Arduino UNO)

**已實現功能：**

*   **連線能力**：
    *   透過 ESP-01S 模組使用 AT Command 進行 Wi-Fi 連線。
    *   支援 UDP 廣播以發現後端伺服器 IP。
    *   透過 TCP POST 請求與 FastAPI 後端伺服器進行通訊。
*   **感測器整合**：
    *   **AMG8833 熱像儀**：初始化、像素矩陣更新、錯誤追蹤。**注意：`Melopero_AMG8833` 函式庫已修改，`pixelMatrix` 現在儲存的是乘以 25 的 `int16_t` 值，而非原始 `float` 溫度。這項修改是為了節省記憶體，並與後端期望的整數值格式保持一致。**
    *   **電壓感測器**：讀取類比電壓並計算電池電量代碼。
    *   **ESP32-S3 視覺模組**：透過 I2C 請求 IP 位址來追蹤其狀態。
*   **致動器控制**：
    *   **馬達**：初始化、速度控制 (`Velocity_Controller`, `Motors_Set`, `PWM_Out`)。
    *   **舵機**：初始化、角度控制。
    *   **RGB LED**：狀態顯示控制 (`Rgb_Show`, `setLedStatus`)。
    *   **蜂鳴器**：控制 (`controlBuzzer`)。
*   **通訊協定**：
    *   **手動建構 JSON 請求體**：不再使用 `Arduino_JSON` 函式庫，而是透過 C 語言字串操作手動拼接 JSON 數據發送給伺服器。這極大地減少了 SRAM 使用。
    *   **手動解析 JSON 回應**：使用 `get_json_int_value` 函式手動從伺服器回應中解析指令值。
    *   **AT Command 處理**：`sendAtCommand` 函式用於發送 AT Command 並處理回應。
*   **狀態管理**：使用全域變數追蹤 Wi-Fi 連線狀態、感測器錯誤、馬達錯誤和通訊錯誤。

**完整性/潛在問題評估：**

*   **核心功能**：所有原始功能（馬達控制、舵機、LED、蜂鳴器、熱感測器、電壓感測器、與 FastAPI 伺服器的 Wi-Fi 通訊、UDP 發現）似乎都已保留。
*   **記憶體優化**：激進的記憶體優化（手動 JSON 處理、移除 `Arduino_JSON` 函式庫、熱數據使用 `int16_t`、縮減緩衝區）已成功實施，使程式碼能在 Arduino UNO 有限的 SRAM 上編譯和運行。這改變了實現細節，但旨在保持相同的功能行為。
*   **手動 JSON 處理的穩健性**：手動 JSON 解析器 (`get_json_int_value`) 較為基礎，它假設鍵值對的格式和順序是固定的。如果伺服器回應的 JSON 格式變得更複雜或順序改變，可能需要更複雜的解析邏輯。
*   **`Melopero_AMG8833` 修改的影響**：將 `pixelMatrix` 從 `float` 改為 `int16_t` 節省了記憶體，但意味著函式庫內部不再儲存原始的浮點溫度。對於目前僅將這些值發送給後端的用途來說是可行的，但如果未來 Arduino 端需要對原始浮點溫度進行其他計算，則可能需要重新評估。

### 2. `esp32_cam.ino` (ESP32-S3)

**已實現功能：**

*   **連線能力**：
    *   Wi-Fi 連線。
    *   基於 `WebServer` 函式庫的 MJPEG 影像串流伺服器。
*   **相機功能**：
    *   初始化相機 (`setup_camera`)。
    *   捕獲影像幀 (`esp_camera_fb_get`)。
*   **I2C 從機功能**：
    *   初始化 I2C 從機。
    *   透過 I2C 向主機（Arduino UNO）提供自身的 IP 位址 (`sendIpAddress`)。
*   **影像串流**：`handle_stream` 函式負責處理 MJPEG 影像串流的 HTTP 請求和回應。
*   **後端通訊**：
    *   **UDP 服務發現**：監聽後端伺服器的 UDP 廣播，發現後端 IP。
    *   **自動註冊**：在發現後端 IP 後，自動向後端 `/api/register_camera` 註冊自身 IP。
    *   **定期同步**：透過 `http_sync_callback` 定期向後端 `/api/sync` 發送感測器數據（從 UNO 接收）並獲取控制命令。
    *   **日誌優化**：在數據未變化時，減少詳細日誌輸出。

**完整性/潛在問題評估：**

*   **核心功能**：相機初始化、Wi-Fi 上的 MJPEG 串流、I2C IP 位址報告、以及與後端的雙向同步功能都已實現。
*   **Arduino 相容性**：程式碼已成功從混合 ESP-IDF/Arduino 風格遷移到純 Arduino-ESP32 風格。`Wire.write()` 的修正確保了穩健的 I2C 通訊。
*   **串流邏輯**：串流邏輯對於基本的 Web 伺服器來說是健全的。
*   **錯誤處理**：`setup_camera` 中的 `ESP.restart()` 是一個硬重啟，對於某些生產環境可能需要更精細的錯誤恢復機制。

### 結論

經過修改，兩個微控制器上的核心功能都已根據原始碼分析得到保留。這些變更主要體現在實現方式上（例如，記憶體高效的 C 語言風格字串處理、Arduino 原生 API 的使用），而非功能本身。考慮到硬體限制和當前需求，所做的權衡（例如，熱數據的 `int16_t` 儲存、基礎的 JSON 解析）是必要的。程式碼現在應該能夠在各自的硬體平台上成功編譯和運行，並提供預期的功能。