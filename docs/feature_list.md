## Miniauto 專案功能列表

本文件詳細列出了 Miniauto 專案中各個組件已實現的功能。

### 1. 後端服務 (Python FastAPI)

**核心功能：**
*   作為 Miniauto 系統的中央控制與數據匯集平台。
*   提供 RESTful API 接口供前端裝置（ESP32-CAM）及使用者介面互動。
*   實時處理來自車輛的感測器數據，並根據控制模式生成相應的控制指令。
*   整合視覺處理模組，實現基於影像的避障與自主導航。

**API 端點：**
*   **`/api/sync` (POST)**：
    *   **功能**：接收 ESP32 的車輛狀態數據（狀態字節、電壓、熱成像數據、ESP32 IP、超音波距離），並回傳控制指令（指令字節、馬達速度、方向、舵機角度）。
    *   **數據處理**：觸發熱成像數據分析，並根據當前控制模式生成指令。
*   **`/api/register_camera` (POST)**：
    *   **功能**：註冊 ESP32-S3 視覺模組的 IP 地址，並啟動後端相機串流處理器。
*   **`/api/manual_control` (POST)**：
    *   **功能**：設定車輛的手動控制指令（馬達速度、方向、舵機角度、指令字節），這些指令將在下一次 `/api/sync` 回應中發送給 ESP32。
*   **`/api/set_control_mode` (POST)**：
    *   **功能**：切換車輛的控制模式（`manual` 手動, `avoidance` 避障, `autonomous` 自主）。
*   **`/api/latest_data` (GET)**：
    *   **功能**：獲取後端儲存的最新車輛數據、最新發送的指令、ESP32-S3 IP 和當前控制模式。
*   **`/api/logs` (GET)**：
    *   **功能**：獲取後端服務的運行日誌。
*   **`/camera/start` (POST)**：
    *   **功能**：啟動後端相機串流處理器，開始從 ESP32-CAM 獲取影像。
*   **`/camera/stop` (POST)**：
    *   **功能**：停止後端相機串流處理器。
*   **`/camera/status` (GET)**：
    *   **功能**：獲取後端相機串流處理器的運行狀態。
*   **`/camera/analysis` (GET)**：
    *   **功能**：獲取最新處理過的影像分析結果。
*   **`/camera/stream` (GET)**：
    *   **功能**：從後端串流 MJPEG 影像，該影像已由後端進行視覺分析處理。

**控制邏輯與數據分析：**
*   **多模式控制**：支援手動、避障和自主三種控制模式，可動態切換。
*   **熱成像分析**：對接收到的熱成像數據進行基本分析，包括最大、最小、平均溫度和熱點檢測。
*   **視覺分析**：
    *   從 ESP32-CAM 獲取 MJPEG 影像串流。
    *   使用 OpenCV 進行實時影像處理，包括亮度閾值、高斯模糊、輪廓檢測。
    *   實現基於 ROI（感興趣區域）的障礙物檢測，並判斷障礙物的位置和面積。
    *   根據視覺分析結果生成馬達速度和方向指令，實現避障和自主導航。

**系統管理：**
*   **動態模組載入**：後端 API 路由可從 `src/py_rear/apis` 目錄動態載入。
*   **日誌記錄**：內建循環日誌緩衝區，限制日誌條目數量以避免記憶體溢出。

### 2. Arduino UNO 韌體 (`src/miniauto/arduino_uno/arduino_uno.ino`)

**核心功能：**
*   作為車輛的實時控制單元，負責硬體接口、感測器數據採集和致動器控制。
*   透過 Wi-Fi 與後端服務進行通訊，同步車輛狀態並接收控制指令。

**通訊：**
*   **Wi-Fi 連線**：透過 ESP-01S 模組（SoftwareSerial）進行 Wi-Fi 連線和 AT Command 溝通。
*   **伺服器發現**：支援 UDP 廣播以動態發現後端 FastAPI 伺服器的 IP 地址。
*   **數據同步**：定期向後端 `/api/sync` 端點發送 TCP POST 請求，上傳車輛狀態數據。
*   **I2C Master**：作為 I2C 主機，從 ESP32-CAM 獲取其 IP 地址。

**感測器數據採集：**
*   **AMG8833 熱像儀**：初始化並讀取 8x8 像素的熱數據。**注意：熱數據在函式庫內部已直接處理為乘以 25 的 `int16_t` 值，以節省記憶體並符合後端期望的格式。**
*   **電池電壓感測器**：讀取類比電壓值，並計算電池電量狀態。
*   **ESP32-S3 視覺模組狀態**：透過 I2C 通訊判斷 ESP32-S3 模組是否正常工作。

**致動器控制：**
*   **馬達控制**：精確控制四個馬達的 PWM 輸出和方向，實現車輛的速度和方向控制。
*   **舵機控制**：控制舵機的角度。
*   **RGB LED 指示**：根據車輛狀態（Wi-Fi 連線、錯誤、忙碌）和後端指令顯示不同顏色。
*   **蜂鳴器提示**：根據後端指令發出不同模式的蜂鳴器。

**記憶體優化：**
*   **極致 SRAM 優化**：
    *   所有字串常數儲存在 Flash 記憶體（`PROGMEM`）。
    *   完全移除 `String` 物件，改用固定大小的 `char` 陣列和 C 語言字串操作，避免記憶體碎片。
    *   手動構建和解析 JSON 數據，徹底消除 `Arduino_JSON` 函式庫的記憶體開銷。
    *   精簡全域緩衝區大小。
*   **高效數據處理**：熱數據在函式庫層面直接轉換為 `int16_t`，減少數據儲存的記憶體佔用。

### 3. ESP32-CAM 韌體 (`src/miniauto/esp32_cam/esp32_cam.ino`)

**核心功能：**
*   作為獨立的視覺模組，負責相機影像採集和透過 Wi-Fi 提供 MJPEG 影像串流。
*   作為 I2C 從機，向 Arduino UNO 提供自身的 IP 地址。

**通訊：**
*   **Wi-Fi 連線**：連接到指定的 Wi-Fi 網路。
*   **MJPEG 影像串流**：
    *   啟動一個基於 Arduino `WebServer` 函式庫的 HTTP 伺服器。
    *   在 `/stream` 端點提供實時 MJPEG 影像串流，供後端服務或其他客戶端獲取。
*   **I2C Slave**：
    *   初始化 I2C 從機。
    *   當 I2C 主機（Arduino UNO）請求時，透過 I2C 總線發送自身的 IP 地址。
*   **後端通訊**：
    *   **UDP 服務發現**：監聽後端伺服器的 UDP 廣播，發現後端 IP。
    *   **自動註冊**：在發現後端 IP 後，自動向後端 `/api/register_camera` 註冊自身 IP。
    *   **定期同步**：透過 `http_sync_callback` 定期向後端 `/api/sync` 發送感測器數據（從 UNO 接收）並獲取控制命令。

**相機功能：**
*   **相機初始化**：配置 GC2145 相機的 Pin 腳、時鐘頻率、像素格式、幀大小、JPEG 品質和幀緩衝區。
*   **影像採集**：從相機獲取影像幀。